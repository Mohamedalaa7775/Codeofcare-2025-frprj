<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>خدمة تنظيم الأدوية</title>
  <style>
    body {
      font-family: 'Cairo', sans-serif;
      background: #080c14;
      padding: 20px;
    }
    h1 {
      text-align: center;
      color: #4bb9f0;
    }
    form {
    background: #152033;
    padding: 40px;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    max-width: 650px;
    margin: auto;
    }
    label {
    display: block;
    margin-top: 15px;
    margin-right: -15px;
    color: #EEE;
    font-weight: bold;
    font-family: "Rubik", sans-serif;
    }
    input, select, button {
    width: 102%;
    padding: 15px;
    margin-top: 10px;
    border-radius: 11px;
    border: 1px solid #ccc;
    font-size: 1em;
    margin-right: -22px;
    }
    
    select {
      width: 107%;
    }



    button {
    background: #0077b6;
    color: white;
    border: none;
    cursor: pointer;
    margin-top: 15px;
    transform: translateX(-15px);
    }
    table {
      width: 100%;
      margin-top: 30px;
      border-collapse: collapse;
    }
    th, td {
    padding: 12px;
    font-size: 20px;
    color: #EEE;
    text-align: center;
    border-bottom: 1px solid #ccc;
    }
    .container {
      max-width: 900px;
      margin: auto;
    }
    .delete-btn {
      background: #e63946;
      color: white;
      padding: 5px 10px;
      border-radius: 5px;
      cursor: pointer;
      border: none;
    }
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #2a9d8f;
      color: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      display: none;
      z-index: 1000;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>منظم الأدوية لمرضى السكر والضغط والقلب</h1>
    <form id="medicineForm">
      <label>اسم الدواء:</label>
      <input type="text" id="medName" required>

      <label>عدد المرات في اليوم (1-9):</label>
      <input type="number" id="timesPerDay" min="1" max="9" required>

      <label>المواعيد (افصل بينهم بفاصلة):</label>
      <input type="text" id="timings" placeholder="مثال: 9 صباحًا, 3 مساءً">

      <label>هل الدواء يؤخذ:</label>
      <select id="period">
        <option value="">--اختر--</option>
        <option value="صباحًا فقط">صباحًا فقط</option>
        <option value="مساءً فقط">مساءً فقط</option>
        <option value="في أي وقت">في أي وقت</option>
        <option value="كلاهما">كلاهما</option>
      </select>

      <button type="submit">إضافة الدواء</button>
    </form>

    <table id="medTable">
      <thead>
        <tr>
          <th>اسم الدواء</th>
          <th>عدد المرات</th>
          <th>المواعيد</th>
          <th>الوقت</th>
          <th>إجراءات</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="notification" id="notification">
    حان وقت تناول دواء: <span id="medToTake"></span>
  </div>

  <script>
    const form = document.getElementById('medicineForm');
    const tableBody = document.querySelector('#medTable tbody');
    const notification = document.getElementById('notification');
    const medToTakeSpan = document.getElementById('medToTake');
    let checkTimers = [];

    function saveMedicine(meds) {
      localStorage.setItem('medicines', JSON.stringify(meds));
    }

    function loadMedicines() {
      const meds = JSON.parse(localStorage.getItem('medicines')) || [];
      tableBody.innerHTML = '';
      meds.forEach((med, index) => addRow(med, index));
      setupReminders(meds);
    }

    function addRow(med, index) {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${med.name}</td>
        <td>${med.times}</td>
        <td>${med.timings}</td>
        <td>${med.period}</td>
        <td><button class="delete-btn" data-index="${index}">حذف</button></td>
      `;
      tableBody.appendChild(row);
      
      // Add event listener to delete button
      row.querySelector('.delete-btn').addEventListener('click', () => {
        deleteMedicine(index);
      });
    }

    function deleteMedicine(index) {
      const currentMeds = JSON.parse(localStorage.getItem('medicines')) || [];
      currentMeds.splice(index, 1);
      saveMedicine(currentMeds);
      loadMedicines();
    }

    function setupReminders(medicines) {
      // Clear any existing timers
      checkTimers.forEach(timer => clearInterval(timer));
      checkTimers = [];
      
      // Setup new timers for each medicine timing
      medicines.forEach(med => {
        if (med.timings) {
          const times = med.timings.split(',').map(t => t.trim());
          times.forEach(time => {
            const timer = setInterval(() => {
              checkTime(time, med.name);
            }, 60000); // Check every minute
            checkTimers.push(timer);
          });
        }
      });
    }

    function checkTime(scheduledTime, medName) {
      const now = new Date();
      const currentHours = now.getHours();
      const currentMinutes = now.getMinutes();
      
      // Convert scheduled time to 24-hour format
      let [time, period] = scheduledTime.split(' ');
      let hours = parseInt(time);
      
      if (period === 'مساءً' && hours < 12) {
        hours += 12;
      } else if (period === 'صباحًا' && hours === 12) {
        hours = 0;
      }
      
      // Check if it's time to take medicine (with 1 minute tolerance)
      if (Math.abs(currentHours - hours) === 0 && Math.abs(currentMinutes - 0) <= 1) {
        showNotification(medName);
      }
    }

    function showNotification(medName) {
      medToTakeSpan.textContent = medName;
      notification.style.display = 'block';
      
      // Hide notification after 10 seconds
      setTimeout(() => {
        notification.style.display = 'none';
      }, 10000);
      
      // In a real app, you would also send a push notification here
      // For Firebase, you would use Firebase Cloud Messaging (FCM)
    }

    form.addEventListener('submit', (e) => {
      e.preventDefault();
      const name = document.getElementById('medName').value.trim();
      const times = document.getElementById('timesPerDay').value;
      const timings = document.getElementById('timings').value.trim();
      const period = document.getElementById('period').value;

      const newMed = { name, times, timings, period };

      const currentMeds = JSON.parse(localStorage.getItem('medicines')) || [];
      currentMeds.push(newMed);
      saveMedicine(currentMeds);
      loadMedicines();

      form.reset();
    });

    // Initialize
    window.onload = loadMedicines;
  </script>
</body>
</html>